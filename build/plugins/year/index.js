(()=>{"use strict";const e=window.React,t=window.wp.plugins,n=window.wp.editPost,l=window.wp.components,i=window.wp.data,a=window.wp.coreData,r=window.wp.blockEditor,o=window.wp.richText;let m,c,u,s,d,_=null;const v=e=>{const t={..._,mve_timeline_image:e?e.id:null,mve_timeline_image_src:e?JSON.stringify(e.sizes):null};e||(t.mve_timeline_image_source=null,t.mve_timeline_image_info=null,t.mve_timeline_image_src=null),d(t)},p=e=>{d({..._,mve_timeline_image_source:e})},g=e=>{d({..._,mve_timeline_image_info:e})},E=function(){return(0,e.createElement)(r.MediaUploadCheck,null,(0,e.createElement)(l.__experimentalText,{upperCase:!0},"Image"),(0,e.createElement)(r.MediaUpload,{onSelect:v,allowedTypes:["image"],value:m,render:({open:t})=>(0,e.createElement)(e.Fragment,null,s&&(0,e.createElement)("div",{style:{display:"block"}},(0,e.createElement)(l.ResponsiveWrapper,{naturalWidth:s.media_details.width,naturalHeight:s.media_details.height},(0,e.createElement)("img",{src:s.source_url}))),(0,e.createElement)("div",{style:{display:"block"}},!s&&(0,e.createElement)(l.Button,{variant:"secondary",onClick:t},"Open Media Library"),s&&(0,e.createElement)(l.Button,{onClick:()=>v(null),isLink:!0,isDestructive:!0},"Remove image")))}),s&&(0,e.createElement)(l.TextControl,{value:c,onChange:p,label:"Source"}),s&&(0,e.createElement)(l.TextControl,{value:u,onChange:g,label:"Info"}))};let y,C,k=null;const h=function(){const[t,n]=(0,e.useState)(""),[i,a]=(0,e.useState)("");return(0,e.createElement)(e.Fragment,null,(0,e.createElement)("ul",{style:{overflowX:"auto",listStyleType:"none",padding:0,margin:0,marginBottom:"1rem"}},k.map((t=>(0,e.createElement)("li",{key:t.url,style:{whiteSpace:"nowrap"}},(0,e.createElement)(l.Button,{isDestructive:!0,size:"small",onClick:()=>(e=>{const t=[];for(const n of k)n.name===e.name&&n.url===e.url||t.push(n);C({...y,mve_timeline_links:JSON.stringify(t)})})(t)},"X")," ",t.name," - ",t.url)))),(0,e.createElement)(l.TextControl,{value:t,onChange:e=>n(e),label:"Title"}),(0,e.createElement)(l.TextControl,{value:i,onChange:e=>a(e),label:"URL"}),(0,e.createElement)(l.Button,{size:"small",variant:"secondary",onClick:()=>{k.push({name:t,url:i}),C({...y,mve_timeline_links:JSON.stringify(k)}),n(""),a("")},disabled:!(t&&i)},"Add link"))};let w,b,S=null;const x=e=>{b({...w,mve_timeline_intro:e})},f=function(){return(0,e.createElement)(r.RichText,{placeholder:"Intro...",allowedFormats:["core/bold","core/italic","mve-timeline/internal-link"],label:"MVE Timeline Intro",value:S,onChange:x,style:{backgroundColor:"white",padding:"1rem",border:"1px solid #C0C0C0"}})};let T,P,R,I,N,B,F,A,V=null;function M(e){e=parseInt(e,10),V("postType","mve_timeline_item",R,{mve_timeline:isNaN(e)?[0]:[parseInt(e,10)]})}const D=e=>{""===e?P({...T,mve_timeline_year:null}):(e=parseInt(e,10),P({...T,mve_timeline_year:isNaN(e)?null:e.toString()}))},L=e=>{""===e?P({...T,mve_timeline_year_end:null}):(e=parseInt(e,10),P({...T,mve_timeline_year_end:isNaN(e)?null:e.toString()}))},O={backgroundColor:"red",color:"white"},H=function(e,t,n){var l,a;T=e,P=t,R=n;const r=(0,i.useDispatch)("core");V=r.editEntityRecord,I=(0,i.useSelect)((e=>e("core").getEntityRecords("taxonomy","mve_timeline",{orderBy:"name",order:"asc",per_page:-1}))),N=(0,i.useSelect)((e=>e("core/editor").getEditedPostAttribute("mve_timeline")),[]),B=[{value:0,label:"Choose timeline..."}].concat(I?I.map((e=>({value:e.id,label:e.name}))):[]),F=null!==(l=e.mve_timeline_year)&&void 0!==l?l:"",A=null!==(a=e.mve_timeline_year_end)&&void 0!==a?a:""},J=function(){return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(l.__experimentalHStack,null,(0,e.createElement)(l.TextControl,{style:F?null:O,onChange:D,value:F,label:"Year start"}),(0,e.createElement)(l.TextControl,{onChange:L,value:A,label:"Year end"})),(0,e.createElement)(l.SelectControl,{style:N&&0!==N.length&&0!==N[0]?null:O,label:"Timeline",options:B,onChange:M,value:N?N[0]:""}))};wp.domReady((()=>{let e=!1;(0,i.subscribe)((()=>{const t=(0,i.select)("core/editor").getEditedPostAttribute("meta"),n=(0,i.select)("core/editor").getEditedPostAttribute("mve_timeline");t&&n&&(t.mve_timeline_year&&0!==n.length&&0!==n[0]?e&&(e=!1,(0,i.dispatch)("core/editor").unlockPostSaving("requiredValueLock")):e||(e=!0,(0,i.dispatch)("core/editor").lockPostSaving("requiredValueLock")))}))})),(0,t.registerPlugin)("mve-timeline",{render:function(){var t;const r=(0,i.useSelect)((e=>e("core/editor").getCurrentPostType()),[]),o=(0,i.useSelect)((e=>e("core/editor").getCurrentPostId()),[]),{editEntityRecord:v}=(0,i.useDispatch)("core"),[p,g]=(0,a.useEntityProp)("postType",r,"meta");!function(e,t){var n,l;_=e,d=t,m=e.mve_timeline_image,c=null!==(n=e.mve_timeline_image_source)&&void 0!==n?n:"",u=null!==(l=e.mve_timeline_image_info)&&void 0!==l?l:"",s=(0,i.useSelect)((e=>e("core").getMedia(m)),[m])}(p,g),function(e,t){y=e,C=t,k=e.mve_timeline_links,k=k?JSON.parse(k):[]}(p,g),function(e,t){w=e,b=t,S=e.mve_timeline_intro}(p,g),H(p,g,o);const x=null!==(t=p.mve_timeline_content)&&void 0!==t&&t,T={backgroundColor:"#F3F3F3",padding:".4rem",width:"100%"};return(0,e.createElement)(n.PluginDocumentSettingPanel,{title:"MVE Timeline",initialOpen:!0,name:"mve_timeline_panel"},(0,e.createElement)(l.PanelRow,null,(0,e.createElement)("div",{style:T},(0,e.createElement)(l.__experimentalVStack,null,(0,e.createElement)(J,null)))),(0,e.createElement)(l.PanelRow,null,(0,e.createElement)("div",{style:T},(0,e.createElement)(l.CheckboxControl,{label:"Has content",checked:x,onChange:e=>{g({...p,mve_timeline_content:e})}}))),(0,e.createElement)(l.PanelRow,null,(0,e.createElement)("div",{style:T},(0,e.createElement)(l.__experimentalVStack,null,(0,e.createElement)(E,null)))),(0,e.createElement)(l.PanelRow,null,(0,e.createElement)("div",{style:T},(0,e.createElement)(l.__experimentalVStack,null,(0,e.createElement)(l.__experimentalText,{upperCase:!0},"Intro"),(0,e.createElement)(f,null)))),(0,e.createElement)(l.PanelRow,null,(0,e.createElement)("div",{style:T},(0,e.createElement)(l.__experimentalVStack,null,(0,e.createElement)(l.__experimentalText,{upperCase:!0},"Links"),(0,e.createElement)(h,null)))))}});const z=({pages:t,onChange:n,value:i})=>(0,e.createElement)(l.SelectControl,{style:{minWidth:"300px"},__nextHasNoMarginBottom:!0,value:i,label:"Select page",onChange:n,options:t.map((function(e){return{value:e.id,label:`${e.meta.mve_timeline_year} - ${e.title.raw}`}}))});(0,o.registerFormatType)("mve-timeline/internal-link",{title:"Internal link",tagName:"a",className:"mve-internal-link",attributes:{name:"data-internal-id"},edit:({isActive:t,onChange:n,value:a,activeAttributes:m,contentRef:c})=>{const[u,s]=(0,e.useState)(c.current),d=(0,i.useSelect)((e=>e("core/editor").getCurrentPostId()),[]),_=(0,i.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]);if(_&&!["core/paragraph","mve-timeline/intro"].includes(_.name))return null;const v=(0,i.useSelect)((e=>e("core/editor").getEditedPostAttribute("mve_timeline")),[]),p=(0,i.useSelect)((e=>e("core").getEntityRecords("postType","mve_timeline_item",v&&d?{mve_timeline:v,exclude:[d]}:{})),[v,d]);return(0,e.createElement)(r.BlockControls,null,(0,e.createElement)(l.ToolbarButton,{icon:"admin-links",title:"Internal link",onClick:()=>{n((0,o.toggleFormat)(a,{type:"mve-timeline/internal-link"}))},isActive:t}),t&&p&&(0,e.createElement)(l.Popover,{anchor:u,variant:"toolbar"},(0,e.createElement)(l.Card,null,(0,e.createElement)(l.CardBody,null,(0,e.createElement)(z,{pages:p,value:m?.name,onChange:e=>{const t=(0,o.applyFormat)(a,{type:"mve-timeline/internal-link",attributes:{name:e}});n(t)}})))))}})})();