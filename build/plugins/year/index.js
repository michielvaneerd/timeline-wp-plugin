(()=>{"use strict";const e=window.React,t=window.wp.plugins,n=window.wp.editPost,l=window.wp.components,i=window.wp.data,a=window.wp.coreData,r=window.wp.blockEditor,m=window.wp.richText;(0,t.registerPlugin)("mve-timeline",{render:function(){var t,m,o,c;const s=(0,i.useSelect)((e=>e("core/editor").getCurrentPostType()),[]),u=(0,i.useSelect)((e=>e("core/editor").getCurrentPostId()),[]),{editEntityRecord:d}=(0,i.useDispatch)("core"),[_,v]=(0,a.useEntityProp)("postType",s,"meta"),[p,g]=(0,e.useState)(""),[E,y]=(0,e.useState)(""),C=null!==(t=_.mve_timeline_year)&&void 0!==t?t:"",w=null!==(m=_.mve_timeline_year_end)&&void 0!==m?m:"",k=_.mve_timeline_image,S=null!==(o=_.mve_timeline_image_source)&&void 0!==o?o:"",h=null!==(c=_.mve_timeline_image_info)&&void 0!==c?c:"";let b=_.mve_timeline_links;b=b?JSON.parse(b):[];const T=e=>{const t={..._,mve_timeline_image:e?e.id:null,mve_timeline_image_src:e?e.url:null};e||(t.mve_timeline_image_source=null,t.mve_timeline_image_info=null,t.mve_timeline_image_src=null),v(t)},x=(0,i.useSelect)((e=>e("core").getEntityRecords("taxonomy","mve_timeline",{orderBy:"name",order:"asc",per_page:-1}))),P=(0,i.useSelect)((e=>e("core/editor").getEditedPostAttribute("mve_timeline")),[]),f=(0,i.useSelect)((e=>e("core").getMedia(k)),[k]),N=[{value:0,label:"Choose timeline..."}].concat(x?x.map((e=>({value:e.id,label:e.name}))):[]),R={backgroundColor:"#F3F3F3",padding:".4rem",width:"100%"};return(0,e.createElement)(n.PluginDocumentSettingPanel,{title:"MVE Timeline",initialOpen:!0,name:"mve_timeline_panel"},(0,e.createElement)(l.PanelRow,null,(0,e.createElement)("div",{style:R},(0,e.createElement)(l.__experimentalHStack,null,(0,e.createElement)(l.TextControl,{onChange:e=>{""===e?v({..._,mve_timeline_year:null}):(e=parseInt(e,10),v({..._,mve_timeline_year:isNaN(e)?null:e.toString()}))},value:C,label:"Year start"}),(0,e.createElement)(l.TextControl,{onChange:e=>{""===e?v({..._,mve_timeline_year_end:null}):(e=parseInt(e,10),v({..._,mve_timeline_year_end:isNaN(e)?null:e.toString()}))},value:w,label:"Year end"})))),(0,e.createElement)(l.PanelRow,null,(0,e.createElement)("div",{style:R},(0,e.createElement)(l.SelectControl,{label:"Timeline",options:N,onChange:function(e){e=parseInt(e,10),d("postType","mve_timeline_item",u,{mve_timeline:isNaN(e)?[0]:[parseInt(e,10)]})},value:P?P[0]:""}))),(0,e.createElement)(l.PanelRow,null,(0,e.createElement)("div",{style:R},(0,e.createElement)(l.__experimentalVStack,null,(0,e.createElement)(r.MediaUploadCheck,null,(0,e.createElement)(l.__experimentalText,{upperCase:!0},"Image"),(0,e.createElement)(r.MediaUpload,{onSelect:T,allowedTypes:["image"],value:k,render:({open:t})=>(0,e.createElement)(e.Fragment,null,f&&(0,e.createElement)("div",{style:{display:"block"}},(0,e.createElement)(l.ResponsiveWrapper,{naturalWidth:f.media_details.width,naturalHeight:f.media_details.height},(0,e.createElement)("img",{src:f.source_url}))),(0,e.createElement)("div",{style:{display:"block"}},!f&&(0,e.createElement)(l.Button,{variant:"secondary",onClick:t},"Open Media Library"),f&&(0,e.createElement)(l.Button,{onClick:()=>T(null),isLink:!0,isDestructive:!0},"Remove image")))}),f&&(0,e.createElement)(l.TextControl,{value:S,onChange:e=>{v({..._,mve_timeline_image_source:e})},label:"Source"}),f&&(0,e.createElement)(l.TextControl,{value:h,onChange:e=>{v({..._,mve_timeline_image_info:e})},label:"Info"}))))),(0,e.createElement)(l.PanelRow,null,(0,e.createElement)("div",{style:R},(0,e.createElement)(l.__experimentalVStack,null,(0,e.createElement)(l.__experimentalText,{upperCase:!0},"Links"),(0,e.createElement)("ul",null,b.map((t=>(0,e.createElement)("li",{key:t.url},t.name," - ",t.url,(0,e.createElement)(l.Button,{isDestructive:!0,size:"small",onClick:()=>(e=>{const t=[];for(const n of b)n.name===e.name&&n.url===e.url||t.push(n);v({..._,mve_timeline_links:JSON.stringify(t)})})(t)},"X"))))),(0,e.createElement)(l.TextControl,{value:p,onChange:e=>g(e),label:"Title"}),(0,e.createElement)(l.TextControl,{value:E,onChange:e=>y(e),label:"URL"}),(0,e.createElement)(l.Button,{size:"small",variant:"secondary",onClick:()=>{b.push({name:p,url:E}),v({..._,mve_timeline_links:JSON.stringify(b)}),g(""),y("")},disabled:!(p&&E)},"Add link")))))}});const o=({pages:t,onChange:n,value:i})=>(0,e.createElement)(l.SelectControl,{style:{minWidth:"300px"},__nextHasNoMarginBottom:!0,value:i,label:"Select page",onChange:n,options:t.map((function(e){return{value:e.id,label:`${e.meta.mve_timeline_year} - ${e.title.raw}`}}))});(0,m.registerFormatType)("mve-timeline/internal-link",{title:"Internal link",tagName:"a",className:"mve-internal-link",attributes:{name:"data-internal-id"},edit:({isActive:t,onChange:n,value:a,activeAttributes:c,contentRef:s})=>{const[u,d]=(0,e.useState)(s.current),_=(0,i.useSelect)((e=>e("core/editor").getCurrentPostId()),[]),v=(0,i.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]);if(v&&!["core/paragraph","mve-timeline/intro"].includes(v.name))return null;const p=(0,i.useSelect)((e=>e("core/editor").getEditedPostAttribute("mve_timeline")),[]),g=(0,i.useSelect)((e=>e("core").getEntityRecords("postType","mve_timeline_item",p&&_?{mve_timeline:p,exclude:[_]}:{})),[p,_]);return(0,e.createElement)(r.BlockControls,null,(0,e.createElement)(l.ToolbarButton,{icon:"admin-links",title:"Internal link",onClick:()=>{n((0,m.toggleFormat)(a,{type:"mve-timeline/internal-link"}))},isActive:t}),t&&g&&(0,e.createElement)(l.Popover,{anchor:u,variant:"toolbar"},(0,e.createElement)(l.Card,null,(0,e.createElement)(l.CardBody,null,(0,e.createElement)(o,{pages:g,value:c?.name,onChange:e=>{const t=(0,m.applyFormat)(a,{type:"mve-timeline/internal-link",attributes:{name:e}});n(t)}})))))}})})();