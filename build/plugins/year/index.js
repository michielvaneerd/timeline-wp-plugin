(()=>{"use strict";const e=window.React,t=window.wp.plugins,l=window.wp.editPost,n=window.wp.components,i=window.wp.data,a=window.wp.coreData,r=window.wp.blockEditor,o=window.wp.richText;wp.domReady((()=>{let e=!1;(0,i.subscribe)((()=>{const t=(0,i.select)("core/editor").getEditedPostAttribute("meta");t&&(t.mve_timeline_year?e&&(console.log("Unlock"),e=!1,(0,i.dispatch)("core/editor").unlockPostSaving("requiredValueLock")):e||(console.log("Lock"),e=!0,(0,i.dispatch)("core/editor").lockPostSaving("requiredValueLock")))}))})),(0,t.registerPlugin)("mve-timeline",{render:function(){var t,o,m,c,s;const u=(0,i.useSelect)((e=>e("core/editor").getCurrentPostType()),[]),d=(0,i.useSelect)((e=>e("core/editor").getCurrentPostId()),[]),{editEntityRecord:_}=(0,i.useDispatch)("core"),[v,p]=(0,a.useEntityProp)("postType",u,"meta"),[g,E]=(0,e.useState)(""),[y,k]=(0,e.useState)(""),C=null!==(t=v.mve_timeline_year)&&void 0!==t?t:"",w=null!==(o=v.mve_timeline_year_end)&&void 0!==o?o:"",h=v.mve_timeline_image,b=null!==(m=v.mve_timeline_image_source)&&void 0!==m?m:"",S=null!==(c=v.mve_timeline_image_info)&&void 0!==c?c:"",x=v.mve_timeline_intro,T=null!==(s=v.mve_timeline_content)&&void 0!==s&&s;let P=v.mve_timeline_links;P=P?JSON.parse(P):[];const R=e=>{const t={...v,mve_timeline_image:e?e.id:null,mve_timeline_image_src:e?e.url:null};e||(t.mve_timeline_image_source=null,t.mve_timeline_image_info=null,t.mve_timeline_image_src=null),p(t)},f=(0,i.useSelect)((e=>e("core").getEntityRecords("taxonomy","mve_timeline",{orderBy:"name",order:"asc",per_page:-1}))),I=(0,i.useSelect)((e=>e("core/editor").getEditedPostAttribute("mve_timeline")),[]),N=(0,i.useSelect)((e=>e("core").getMedia(h)),[h]),B=f?f.map((e=>({value:e.id,label:e.name}))):[],F={backgroundColor:"#F3F3F3",padding:".4rem",width:"100%"};return(0,e.createElement)(l.PluginDocumentSettingPanel,{title:"MVE Timeline",initialOpen:!0,name:"mve_timeline_panel"},(0,e.createElement)(n.PanelRow,null,(0,e.createElement)("div",{style:F},(0,e.createElement)(n.__experimentalHStack,null,(0,e.createElement)(n.TextControl,{style:{borderColor:C?"":"red"},onChange:e=>{""===e?p({...v,mve_timeline_year:null}):(e=parseInt(e,10),p({...v,mve_timeline_year:isNaN(e)?null:e.toString()}))},value:C,label:"Year start"}),(0,e.createElement)(n.TextControl,{onChange:e=>{""===e?p({...v,mve_timeline_year_end:null}):(e=parseInt(e,10),p({...v,mve_timeline_year_end:isNaN(e)?null:e.toString()}))},value:w,label:"Year end"})))),(0,e.createElement)(n.PanelRow,null,(0,e.createElement)("div",{style:F},(0,e.createElement)(n.SelectControl,{label:"Timeline",options:B,onChange:function(e){e=parseInt(e,10),_("postType","mve_timeline_item",d,{mve_timeline:isNaN(e)?[0]:[parseInt(e,10)]})},value:I?I[0]:""}))),(0,e.createElement)(n.PanelRow,null,(0,e.createElement)("div",{style:F},(0,e.createElement)(n.CheckboxControl,{label:"Has content",checked:T,onChange:e=>{p({...v,mve_timeline_content:e})}}))),(0,e.createElement)(n.PanelRow,null,(0,e.createElement)("div",{style:F},(0,e.createElement)(n.__experimentalVStack,null,(0,e.createElement)(r.MediaUploadCheck,null,(0,e.createElement)(n.__experimentalText,{upperCase:!0},"Image"),(0,e.createElement)(r.MediaUpload,{onSelect:R,allowedTypes:["image"],value:h,render:({open:t})=>(0,e.createElement)(e.Fragment,null,N&&(0,e.createElement)("div",{style:{display:"block"}},(0,e.createElement)(n.ResponsiveWrapper,{naturalWidth:N.media_details.width,naturalHeight:N.media_details.height},(0,e.createElement)("img",{src:N.source_url}))),(0,e.createElement)("div",{style:{display:"block"}},!N&&(0,e.createElement)(n.Button,{variant:"secondary",onClick:t},"Open Media Library"),N&&(0,e.createElement)(n.Button,{onClick:()=>R(null),isLink:!0,isDestructive:!0},"Remove image")))}),N&&(0,e.createElement)(n.TextControl,{value:b,onChange:e=>{p({...v,mve_timeline_image_source:e})},label:"Source"}),N&&(0,e.createElement)(n.TextControl,{value:S,onChange:e=>{p({...v,mve_timeline_image_info:e})},label:"Info"}))))),(0,e.createElement)(n.PanelRow,null,(0,e.createElement)("div",{style:F},(0,e.createElement)(n.__experimentalVStack,null,(0,e.createElement)(n.__experimentalText,{upperCase:!0},"Intro"),(0,e.createElement)(r.RichText,{style:{backgroundColor:"white"},placeholder:"Intro...",allowedFormats:["core/bold","core/italic","mve-timeline/internal-link"],label:"MVE Timeline Intro",value:x,onChange:e=>{p({...v,mve_timeline_intro:e})}})))),(0,e.createElement)(n.PanelRow,null,(0,e.createElement)("div",{style:F},(0,e.createElement)(n.__experimentalVStack,null,(0,e.createElement)(n.__experimentalText,{upperCase:!0},"Links"),(0,e.createElement)("ul",{style:{overflowX:"auto",listStyleType:"none",padding:0,margin:0}},P.map((t=>(0,e.createElement)("li",{key:t.url,style:{whiteSpace:"nowrap"}},(0,e.createElement)(n.Button,{isDestructive:!0,size:"small",onClick:()=>(e=>{const t=[];for(const l of P)l.name===e.name&&l.url===e.url||t.push(l);p({...v,mve_timeline_links:JSON.stringify(t)})})(t)},"X")," ",t.name," - ",t.url)))),(0,e.createElement)(n.TextControl,{value:g,onChange:e=>E(e),label:"Title"}),(0,e.createElement)(n.TextControl,{value:y,onChange:e=>k(e),label:"URL"}),(0,e.createElement)(n.Button,{size:"small",variant:"secondary",onClick:()=>{P.push({name:g,url:y}),p({...v,mve_timeline_links:JSON.stringify(P)}),E(""),k("")},disabled:!(g&&y)},"Add link")))))}});const m=({pages:t,onChange:l,value:i})=>(0,e.createElement)(n.SelectControl,{style:{minWidth:"300px"},__nextHasNoMarginBottom:!0,value:i,label:"Select page",onChange:l,options:t.map((function(e){return{value:e.id,label:`${e.meta.mve_timeline_year} - ${e.title.raw}`}}))});(0,o.registerFormatType)("mve-timeline/internal-link",{title:"Internal link",tagName:"a",className:"mve-internal-link",attributes:{name:"data-internal-id"},edit:({isActive:t,onChange:l,value:a,activeAttributes:c,contentRef:s})=>{const[u,d]=(0,e.useState)(s.current),_=(0,i.useSelect)((e=>e("core/editor").getCurrentPostId()),[]),v=(0,i.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]);if(v&&!["core/paragraph","mve-timeline/intro"].includes(v.name))return null;const p=(0,i.useSelect)((e=>e("core/editor").getEditedPostAttribute("mve_timeline")),[]),g=(0,i.useSelect)((e=>e("core").getEntityRecords("postType","mve_timeline_item",p&&_?{mve_timeline:p,exclude:[_]}:{})),[p,_]);return(0,e.createElement)(r.BlockControls,null,(0,e.createElement)(n.ToolbarButton,{icon:"admin-links",title:"Internal link",onClick:()=>{l((0,o.toggleFormat)(a,{type:"mve-timeline/internal-link"}))},isActive:t}),t&&g&&(0,e.createElement)(n.Popover,{anchor:u,variant:"toolbar"},(0,e.createElement)(n.Card,null,(0,e.createElement)(n.CardBody,null,(0,e.createElement)(m,{pages:g,value:c?.name,onChange:e=>{const t=(0,o.applyFormat)(a,{type:"mve-timeline/internal-link",attributes:{name:e}});l(t)}})))))}})})();